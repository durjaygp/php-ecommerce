<?php session_start(); ?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="Description" content="Enter your description here" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">

    <title>Garden Company Login Form</title>
    <style>
        body {
            background-image: url('../bgimage/22.avif');
            background-size: cover;
            background-repeat: no-repeat;
        }

        .bg-primary {
            background: #70c745cf !important;
        }

        canvas {
            pointer-events: none;
        }
    </style>
</head>

<body onload="createCaptcha()">


    <section class="testimonial py-5" id="testimonial">
        <div class="container">
            <div class="row ">
                <div class="col-md-4 py-5 bg-primary text-white text-center ">
                    <div class=" ">
                        <div class="card-body">
                            <img src="http://www.ansonika.com/mavia/img/registration_bg.svg" style="width:30%">
                            <h2 class="py-3">Login</h2>
                            <p>This is the login page for the Garden Company. You will be able
                                to login with the account you have created in the registration Page
                                along with doing a Captcha for security purposes.

                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-8 py-5 border">
                    <h4 class="pb-4">Please fill with your details</h4>
                    <form id="login-form">
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                <input type="email" class="form-control" name="email" id="email" placeholder="Email">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-12">
                                <input type="password" class="form-control" name="password" id="password"
                                    placeholder="password">
                            </div>
                        </div>
                        <div id="captcha" width="100%"></div>
                        <input type="text" class="form-control" id="cpatchaTextBox" placeholder="Enter Captcha Here" />
                        <div class="form-row mt-3">
                            <button type="submit" id="loginsubmit" class="btn btn-success">Submit</button>
                        </div>
                        <a href="../Register.html" class="d-flex justify-content-end">Go To Register Page</a>
                    </form>

                </div>
            </div>
        </div>
        <div class="container mt-2">
            <div class="alert alert-success" id="success-message" role="alert" style="display: none;"></div>
            <div class="alert alert-danger" id="error-message" role="alert" style="display: none;"></div>
        </div>

    </section>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script>
        var code;
        function createCaptcha() {
            document.getElementById('captcha').innerHTML = "";
            var charsArray =
                "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ@!#$%^&*";
            var lengthOtp = 6;
            var captcha = [];
            for (var i = 0; i < lengthOtp; i++) {
                var index = Math.floor(Math.random() * charsArray.length + 1);
                if (captcha.indexOf(charsArray[index]) == -1)
                    captcha.push(charsArray[index]);
                else i--;
            }
            var canv = document.createElement("canvas");
            canv.id = "captcha";
            canv.width = 100;
            canv.height = 50;
            var ctx = canv.getContext("2d");
            ctx.font = "25px Georgia";
            ctx.strokeText(captcha.join(""), 0, 30);
            code = captcha.join("");
            document.getElementById("captcha").appendChild(canv);
        }
        function validateCaptcha() {
            event.preventDefault();
            debugger
            if (document.getElementById("cpatchaTextBox").value == code) {
                var jsonobj = jsonData("#login-form");
                $.ajax({
                    url: 'http://localhost/Project/LoginApi.php',
                    type: 'POST',
                    data: jsonobj,
                    success: function (data) {
                        message(data.message, data.status);
                        if (data.status == true) {
                            var user = data.user;
                            var sessionStorage = window.sessionStorage;
                            sessionStorage.setItem("userid", user.userid);
                            sessionStorage.setItem("useremail", user.email);
                            window.location.href = 'index.php';
                        }
                    }
                });
            } else {

                Swal.fire({
                    icon: 'error',
                    title: 'Captcha Error...',
                    text: 'Invalid Captcha. try Again',
                });
                createCaptcha();
            }
        }
        function jsonData(targetForm) {
            var arr = $(targetForm).serializeArray();
            var object = {};
            for (let index = 0; index < arr.length; index++) {
                object[arr[index].name] = arr[index].value;
            }
            var json_object = JSON.stringify(object);
            return json_object;
        }
        function message(message, status) {

            if (status == true) {
                $("#success-message").css("display", "block");;
                $("#success-message").html(message).slideDown();
                $("#error-message").slideUp();
                setTimeout(function () {
                    $("#success-message").slideUp();
                }, 4000);
            } else if (status == false) {
                $("#error-message").css("display", "block");;
                $("#error-message").html(message).slideDown();
                $("#success-message").slideUp();
                setTimeout(function () {
                    $("#error-message").slideUp();
                }, 4000);
            }
        }


        $(document).ready(function () {

            $('#loginsubmit').click(function (e) {
                e.preventDefault();
                validateCaptcha();
            });
        });
    </script>
</body>

</html>